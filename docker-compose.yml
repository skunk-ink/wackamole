services:
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INDEXD_SDK_REF: main   # or a commit SHA
    container_name: wackamole
    command: >
      python gateway.py
      --host 0.0.0.0
      --port 8787
      --manifest /data/manifest.json
      --no-auth
      --no-auth-fallback
    environment:
      PYTHONUNBUFFERED: "1"
    volumes:
      # Host-editable data dir →
      - ./data/manifest.json:/data/manifest.json
      # Persist the gateway’s .env (used only if auth fallback kicks in)
      - ./data/.env:/app/.env
    ports:
      - "8787:8787"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request as u; u.urlopen('http://127.0.0.1:8787/__health').read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
